// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// ============================================
// Authentication Models (NextAuth.js)
// ============================================

enum UserRole {
  USER
  ADMIN
}

model User {
  id            String    @id @default(cuid())
  name          String?
  email         String    @unique
  emailVerified DateTime?
  image         String?
  role          UserRole  @default(USER)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  accounts Account[]
  sessions Session[]
  pettyCashAccount PettyCashAccount?

  // Stock transaction relations
  stockTransactionsRequested StockTransaction[] @relation("StockTransactionRequester")
  stockTransactionsApproved  StockTransaction[] @relation("StockTransactionApprover")

  @@index([email])
  @@index([role])
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@index([userId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

// ============================================
// Activity Log Model
// ============================================

enum ActivityAction {
  // Auth actions
  LOGIN
  LOGOUT

  // User management
  USER_CREATED
  USER_UPDATED
  USER_DELETED
  USER_ROLE_CHANGED

  // Petty cash actions
  PETTY_CASH_WITHDRAW
  PETTY_CASH_RETURN
  PETTY_CASH_TOPUP
  PETTY_CASH_TRANSFER
  PETTY_CASH_APPROVED
  PETTY_CASH_REJECTED
  PETTY_CASH_EDITED
  PETTY_CASH_DELETED

  // Inventory actions
  STOCK_RECEIVE
  STOCK_WITHDRAW
  STOCK_ADJUST
  STOCK_TRANSFER
  STOCK_APPROVED
  STOCK_REJECTED

  // Sync actions
  DATA_SYNC_STARTED
  DATA_SYNC_COMPLETED
  DATA_SYNC_FAILED
  ITEMS_SYNC_STARTED
  ITEMS_SYNC_COMPLETED
  ITEMS_SYNC_FAILED

  // General
  OTHER
}

model ActivityLog {
  id          String         @id @default(cuid())
  action      ActivityAction
  userId      String?        // User who performed the action (null for system actions)
  userName    String?        // Denormalized for display
  userEmail   String?        // Denormalized for display
  targetId    String?        // ID of the affected resource
  targetType  String?        // Type of resource (User, PettyCash, Stock, etc.)
  description String?        // Human-readable description
  metadata    Json?          // Additional data (old values, new values, etc.)
  ipAddress   String?        // Client IP if available
  userAgent   String?        // Browser/client info
  createdAt   DateTime       @default(now())

  @@index([userId])
  @@index([action])
  @@index([targetType])
  @@index([createdAt])
}

// ============================================
// Application Models
// ============================================

// Main procurement transaction table
model ProcurementTransaction {
  id              Int      @id @default(autoincrement())
  rowNumber       Int      // Original row number from Google Sheets

  // Core fields
  date            DateTime?
  reference       String?   // อ้างอิง
  status          String?   // สถานะ
  contactCode     String?   // รหัสผู้ติดต่อ
  vendor          String?   // ผู้ขาย/ผู้ให้บริการ
  itemNumber      Int?      // รายการที่
  productCode     String?   // รหัสสินค้า/บริการ
  productName     String?   // ชื่อสินค้า/บริการ
  accountChart    String?   // ผังบัญชี
  description     String?   // คำอธิบาย

  // Numeric fields
  quantity        Decimal?  @db.Decimal(18, 4)
  unit            String?   // หน่วย
  price           Decimal?  @db.Decimal(18, 2)
  discount        Decimal?  @db.Decimal(18, 2)
  totalPrice      Decimal?  @db.Decimal(18, 2) // มูลค่าก่อนภาษี

  // Tax fields
  taxType         String?   // ประเภทภาษี
  vatAmount       Decimal?  @db.Decimal(18, 2) // ยอด VAT
  withholdingTax  Decimal?  @db.Decimal(18, 2) // หัก ณ ที่จ่าย
  totalWithVat    Decimal?  @db.Decimal(18, 2) // ยอดรวม VAT (totalPrice + vatAmount)

  // Category fields
  majorGroup      String?   // กลุ่มใหญ่
  minorGroup      String?   // กลุ่มย่อย (department)
  percentage      Decimal?  @db.Decimal(5, 2)

  // Additional fields
  payment         String?
  poNumber        String?   // เลข-PO
  url             String?

  // Hash for change detection
  rowHash         String?   // MD5 hash of row data for change detection

  // Timestamps
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  // Indexes for common queries
  @@index([date])
  @@index([vendor])
  @@index([minorGroup])
  @@index([reference])
  @@index([rowNumber])
  @@unique([rowNumber]) // Each row from sheet is unique
}

// Inventory items from the items sheet
model Item {
  id          String   @id // Item code (e.g., T01001)
  name        String   // Item name
  unit        String?  // Unit (e.g., kg, pack)
  type        String?  // Type (e.g., vegetables, meat)
  category    String?  // Category code
  supplier1   String?  // Primary supplier
  supplier2   String?  // Secondary supplier

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relation to stock management
  stockItem   StockItem?

  @@index([name])
  @@index([category])
  @@index([type])
}

// Sync log to track synchronization history
model SyncLog {
  id            Int      @id @default(autoincrement())
  startedAt     DateTime @default(now())
  completedAt   DateTime?
  status        String   // pending, running, completed, failed
  totalRows     Int?
  insertedRows  Int?
  updatedRows   Int?
  deletedRows   Int?
  errorMessage  String?

  @@index([startedAt])
  @@index([status])
}

// ============================================
// Petty Cash Models
// ============================================

enum PettyCashType {
  WITHDRAW      // เบิกเงิน (ลดยอด)
  RETURN        // คืนเงินทอน (เพิ่มยอด)
  TOPUP         // เติมเงินเข้ากองทุน (เพิ่มยอด)
  TRANSFER_OUT  // โอนออก (ลดยอด)
  TRANSFER_IN   // รับโอน (เพิ่มยอด)
}

enum PettyCashStatus {
  PENDING   // รออนุมัติ
  APPROVED  // อนุมัติแล้ว
  REJECTED  // ปฏิเสธ
}

// Petty Cash Account สำหรับแต่ละคน
model PettyCashAccount {
  id           String   @id @default(cuid())
  userId       String   @unique
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  balance      Decimal  @default(0) @db.Decimal(12, 2)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  transactions PettyCashTransaction[]

  @@index([userId])
}

// Petty Cash Transaction
model PettyCashTransaction {
  id          String           @id @default(cuid())
  accountId   String
  account     PettyCashAccount @relation(fields: [accountId], references: [id], onDelete: Cascade)
  type        PettyCashType
  amount      Decimal          @db.Decimal(12, 2)
  description String?
  reference   String?          // เลขที่เอกสาร
  status      PettyCashStatus  @default(PENDING)
  requestedBy String?          // ผู้ขอเบิก (user id)
  approvedBy  String?          // ผู้อนุมัติ (user id)
  approvedAt  DateTime?
  rejectedAt  DateTime?
  rejectReason String?
  relatedTransactionId String? // สำหรับ transfer - link ไปยัง transaction อีกฝั่ง
  attachmentUrl  String?       // URL ของไฟล์แนบ
  attachmentName String?       // ชื่อไฟล์แนบ
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt

  @@index([accountId])
  @@index([status])
  @@index([createdAt])
  @@index([type])
}

// ============================================
// Inventory/Stock Management Models
// ============================================

enum StockTransactionType {
  RECEIVE       // นำเข้าสินค้า (auto-approve)
  WITHDRAW      // เบิกจ่ายสินค้า (conditional)
  ADJUST_IN     // ปรับยอดเพิ่ม (needs approval)
  ADJUST_OUT    // ปรับยอดลด (needs approval)
  TRANSFER_OUT  // โอนออก (needs approval)
  TRANSFER_IN   // รับโอน (auto-approve)
  RETURN        // คืนสินค้า (auto-approve)
}

enum StockTransactionStatus {
  PENDING       // รออนุมัติ
  APPROVED      // อนุมัติแล้ว
  REJECTED      // ปฏิเสธ
}

// Stock Item - extends Item with stock-specific fields
model StockItem {
  id              String   @id @default(cuid())
  itemId          String   @unique  // Link to existing Item table
  item            Item     @relation(fields: [itemId], references: [id])

  // Stock tracking
  currentQuantity Decimal  @default(0) @db.Decimal(18, 4)
  minQuantity     Decimal? @db.Decimal(18, 4)  // Reorder point
  maxQuantity     Decimal? @db.Decimal(18, 4)  // Max stock level

  // Cost tracking
  averageCost     Decimal? @db.Decimal(18, 2)  // Weighted average cost
  lastCost        Decimal? @db.Decimal(18, 2)  // Most recent cost

  // Location (optional)
  location        String?  // Storage location

  // Status
  isActive        Boolean  @default(true)

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  batches         StockBatch[]
  transactionItems StockTransactionItem[]

  @@index([itemId])
  @@index([isActive])
}

// Stock Batch - for tracking expiry dates and FIFO/FEFO
model StockBatch {
  id              String    @id @default(cuid())
  stockItemId     String
  stockItem       StockItem @relation(fields: [stockItemId], references: [id], onDelete: Cascade)

  // Batch info
  batchNumber     String?
  expiryDate      DateTime?
  manufactureDate DateTime?

  // Quantity tracking
  initialQuantity Decimal   @db.Decimal(18, 4)
  currentQuantity Decimal   @db.Decimal(18, 4)

  // Cost for this batch
  unitCost        Decimal   @db.Decimal(18, 2)

  // Source reference
  receiveTransactionId String?  // Link to the transaction that created this batch

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@index([stockItemId])
  @@index([expiryDate])
  @@index([batchNumber])
}

// Stock Transaction - main transaction record
model StockTransaction {
  id              String                  @id @default(cuid())
  transactionNumber String               @unique  // Auto-generated: STK-YYYYMMDD-XXXX
  type            StockTransactionType
  status          StockTransactionStatus  @default(PENDING)

  // Transaction details
  description     String?
  reference       String?                 // External reference (PO number, etc.)
  notes           String?

  // User tracking
  requestedBy     String                  // User ID who created
  requestedByUser User                    @relation("StockTransactionRequester", fields: [requestedBy], references: [id])
  approvedBy      String?                 // User ID who approved/rejected
  approvedByUser  User?                   @relation("StockTransactionApprover", fields: [approvedBy], references: [id])

  // Timestamps
  transactionDate DateTime                @default(now())
  approvedAt      DateTime?
  rejectedAt      DateTime?
  rejectReason    String?

  // For transfers - link to related transaction
  relatedTransactionId String?

  // Attachment
  attachmentUrl   String?
  attachmentName  String?

  createdAt       DateTime                @default(now())
  updatedAt       DateTime                @updatedAt

  // Relations
  items           StockTransactionItem[]

  @@index([type])
  @@index([status])
  @@index([transactionDate])
  @@index([requestedBy])
}

// Stock Transaction Item - line items for each transaction
model StockTransactionItem {
  id              String           @id @default(cuid())
  transactionId   String
  transaction     StockTransaction @relation(fields: [transactionId], references: [id], onDelete: Cascade)

  stockItemId     String
  stockItem       StockItem        @relation(fields: [stockItemId], references: [id])

  // Quantity and cost
  quantity        Decimal          @db.Decimal(18, 4)
  unitCost        Decimal?         @db.Decimal(18, 2)
  totalCost       Decimal?         @db.Decimal(18, 2)

  // For receives - expiry tracking
  batchNumber     String?
  expiryDate      DateTime?

  // Withdraw purpose
  purpose         String?

  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt

  @@index([transactionId])
  @@index([stockItemId])
}

// ============================================
// Daily Petty Cash Report Models
// ============================================

// เก็บยอดเงินสดยกมาแต่ละวัน
model DailyPettyCashBalance {
  id             String   @id @default(cuid())
  date           DateTime @db.Date @unique
  openingBalance Decimal  @db.Decimal(12, 2)
  notes          String?
  createdBy      String
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  @@index([date])
}

// เก็บหมายเหตุสำหรับแต่ละ procurement transaction (petty cash)
model PettyCashTransactionNote {
  id            String   @id @default(cuid())
  transactionId Int      @unique  // Links to ProcurementTransaction.id
  note          String
  createdBy     String
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@index([transactionId])
}

// เก็บยอดจริงที่แก้ไข (เมื่อ Google Sheet มียอดประมาณการ)
model TransactionOverride {
  id            String   @id @default(cuid())
  transactionId Int      @unique  // Links to ProcurementTransaction.id
  actualPrice   Decimal  @db.Decimal(12, 2)  // ยอดซื้อจริง
  reason        String?  // เหตุผลที่แก้ไข
  createdBy     String
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@index([transactionId])
}

// รายการเงินสดย่อยที่เพิ่มด้วยมือ (ไม่ได้มาจาก Google Sheet)
model ManualPettyCashTransaction {
  id          Int      @id @default(autoincrement())
  date        DateTime @db.Date
  reference   String?  // อ้างอิง
  vendor      String?  // ผู้ขาย
  productName String?  // รายการ
  totalPrice  Decimal  @db.Decimal(12, 2)  // จำนวนเงิน
  minorGroup  String?  // แผนก
  note        String?  // หมายเหตุ
  createdBy   String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([date])
}

// รายการที่เพิ่มด้วยมือ (ทุกประเภท payment - ไม่ใช่แค่ petty cash)
model ManualTransaction {
  id          Int      @id @default(autoincrement())
  date        DateTime @db.Date
  reference   String?  // อ้างอิง
  vendor      String?  // ผู้ขาย
  productName String?  // รายการ
  totalPrice  Decimal  @db.Decimal(12, 2)  // จำนวนเงิน
  payment     String?  // ประเภทการจ่าย (เงินสด, โอน, etc.)
  minorGroup  String?  // แผนก
  note        String?  // หมายเหตุ
  createdBy   String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([date])
  @@index([payment])
}
